<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Navbar</title>
    <base target="_blank">
    <style>
        html, body { height: 100%; }
        body { 
            margin: 0; 
            padding: 10px; 
            font-family: sans-serif; 
            background: transparent; /* Transparent so it floats nicely */
            display: flex;
            justify-content: center;
            align-items: flex-end;
            box-sizing: border-box;
        }
        .nav-pill {
            background: #ea4c3b; /* Default Red/Orange */
            border-radius: 50px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            pointer-events: auto; /* Re-enable clicks */
            max-width: 92vw;
            position: relative;
        }
        .home-btn {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .home-btn:hover { background: rgba(255,255,255,0.3); }
        .home-btn svg { width: 20px; height: 20px; fill: white; }
        
        .nav-item {
            padding: 10px 20px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-item.active { background: white; color: #ea4c3b; }
        .arrow { font-size: 10px; opacity: 0.8; }
        .arrow.open { transform: rotate(180deg); }

        /* Dropdown Styles */
        .nav-group { position: relative; display: flex; align-items: center; }
        .dropdown-menu {
            position: absolute;
            bottom: 140%; /* Opens upwards */
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: white;
            min-width: 160px;
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: auto;
        }
        .dropdown-menu.show { display: flex; opacity: 1; transform: translateX(-50%) translateY(0); }
        .dropdown-link {
            padding: 10px 16px;
            color: #333;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
            white-space: nowrap;
        }
        .dropdown-link:hover { background: #f5f5f5; color: #ea4c3b; }

        @media (max-width: 600px) {
            .nav-item {
                padding: 8px 14px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="nav-pill" id="nav-container">
        <div class="home-btn" id="home-btn">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
        </div>
        <!-- Links will be injected here -->
    </div>

    <script>
        // Parse URL parameters
        const params = new URLSearchParams(window.location.search);
        
        // Apply colors
        const bgColor = params.get('bg_color') ? '#' + params.get('bg_color') : '#ea4c3b';
        const textColor = params.get('text_color') ? '#' + params.get('text_color') : '#ffffff';
        const btnBg = params.get('btn_bg') ? '#' + params.get('btn_bg') : 'rgba(255,255,255,0.2)';
        const btnIconColor = params.get('btn_icon_color') ? '#' + params.get('btn_icon_color') : '#ffffff';
        
        const navContainer = document.getElementById('nav-container');
        navContainer.style.backgroundColor = bgColor;

        const homeBtn = document.getElementById('home-btn');
        homeBtn.style.backgroundColor = btnBg;
        homeBtn.querySelector('svg').style.fill = btnIconColor;
        
        // Home button link
        const homeHref = params.get('home_href');
        if(homeHref) homeBtn.onclick = () => window.open(homeHref, '_blank');

        // Build Links
        const links = ['link1', 'link2', 'link3'];
        const activeItem = params.get('active_item');

        links.forEach(key => {
            const text = params.get(key + '_text');
            const href = params.get(key + '_href') || '#';
            const items = params.get(key + '_items'); // Format: Label|Url,Label|Url

            if (text) {
                const group = document.createElement('div');
                group.className = 'nav-group';

                const a = document.createElement('a');
                a.className = 'nav-item';
                a.href = href;
                
                // Dropdown Logic
                let arrowHtml = '';
                if (items) {
                    arrowHtml = ` <span class="arrow" id="arrow-${key}">â–¼</span>`;
                    a.onclick = (e) => {
                        e.preventDefault();
                        toggleDropdown(key);
                    };
                }

                // Check active state
                if (text === activeItem) {
                    a.style.backgroundColor = textColor;
                    a.style.color = bgColor;
                } else {
                    a.style.color = textColor;
                }

                a.innerHTML = `${text}${arrowHtml}`;
                group.appendChild(a);

                // Build Dropdown Menu
                if (items) {
                    const dd = document.createElement('div');
                    dd.className = 'dropdown-menu';
                    dd.id = `dd-${key}`;
                    
                    items.split(',').forEach(item => {
                        const [l, h] = item.split('|');
                        const link = document.createElement('a');
                        link.className = 'dropdown-link';
                        link.textContent = l;
                        link.href = h || '#';
                        dd.appendChild(link);
                    });
                    group.appendChild(dd);
                }

                navContainer.appendChild(group);
            }
        });

        function toggleDropdown(key) {
            const dd = document.getElementById(`dd-${key}`);
            const arrow = document.getElementById(`arrow-${key}`);
            const isHidden = !dd.classList.contains('show');
            
            // Close all others
            document.querySelectorAll('.dropdown-menu').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.arrow').forEach(el => el.classList.remove('open'));

            if (isHidden) {
                dd.classList.add('show');
                arrow.classList.add('open');
                // Request more height for the iframe to show the dropdown
                // Calculate required height: Dropdown height + Pill height + Buffer
                const ddHeight = dd.scrollHeight;
                const pillHeight = navContainer.offsetHeight;
                const totalHeight = ddHeight + pillHeight + 50;
                sendHeight(totalHeight); 
            } else {
                // Reset height
                sendHeight();
            }
        }

        // Close when clicking outside (simulated for iframe environment)
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.nav-group')) {
                document.querySelectorAll('.dropdown-menu').forEach(el => el.classList.remove('show'));
                document.querySelectorAll('.arrow').forEach(el => el.classList.remove('open'));
                sendHeight();
            }
        });

        // Send height to parent
        function sendHeight(forceHeight) {
            // Default to a reasonable pill height if closed, or forced height if open
            const height = forceHeight || 100; 
            const frameId = params.get('frame_id');
            if(frameId) {
                window.parent.postMessage({ frameHeight: height, frameId: frameId }, '*');
            }
        }

        function checkHeight() {
            const openDD = document.querySelector('.dropdown-menu.show');
            if (openDD) {
                const ddHeight = openDD.scrollHeight;
                const pillHeight = navContainer.offsetHeight;
                const totalHeight = ddHeight + pillHeight + 50;
                sendHeight(totalHeight);
            } else {
                sendHeight();
            }
        }

        window.addEventListener('load', checkHeight);
        window.addEventListener('resize', checkHeight);
        setInterval(checkHeight, 100);
    </script>
</body>
</html>